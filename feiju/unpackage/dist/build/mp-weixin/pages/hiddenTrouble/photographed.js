"use strict";const e=require("../../common/vendor.js"),a=require("../../common/assets.js"),l=require("../../api/apis.js"),o=require("../../config.js");if(!Array){(e.resolveComponent("uni-popup")+e.resolveComponent("uni-popup-message"))()}Math||((()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup-message/uni-popup-message.js"))();const u={__name:"photographed",setup(u){const r=e.ref(["请选择","一般隐患","严重隐患","较大隐患","重大隐患"]),n=e.ref(0),t=e.ref(0),s=e.ref(0),i=e.ref([]);e.ref([]);const p=e.ref(""),c=e.ref(""),v=e.ref(""),d=e.ref(""),m=e.ref(""),f=e.ref(""),h=e.ref(""),g=e.ref([]),_=e.ref([]),x=e.ref([]),y=e.index.getRecorderManager(),I=e.index.createInnerAudioContext(),P=e.ref(null),T=e.ref(null),j=e.ref(!1),w=e.ref(!1),$=e.ref(null),b=e.ref(null),k=e.ref([]),F=[],C=[],D={projectId:o.PROJECTID.globalProjectId},E=async()=>{if(!D.sceneId)return void W("请选择场景");if(s.value<1)return void W("请选择隐患等级");if(!p.value)return void W("请填写描述");D.note=p.value,D.level=s.value-1;let a=[...k.value,...g.value];a.length<1?M(D).then((a=>{200===a.code?(f.value="提交成功",d.value.open(),setTimeout((()=>{e.index.navigateBack()}),1e3)):W("提交失败")})).catch((e=>{console.error("提交过程中发生错误",e)})):N(a,((a,l)=>{D.attachmentList=a,D.recordingList=l,M(D).then((a=>{200===a.code?(f.value="提交成功",d.value.open(),setTimeout((()=>{e.index.navigateBack()}),1e3)):W("提交失败")})).catch((e=>{console.error("提交过程中发生错误",e)}))}),(e=>{console.error("文件上传失败",e)}))};async function M(e){return await l.apiAddHiddenDanger(e)}const N=(a,l,u)=>{let r=0;a.forEach((n=>{(n=>{e.index.uploadFile({url:o.BASE_URL+"/minio/fileUpload",filePath:n,name:"file",header:{"Content-Type":"multipart/form-data"},success:e=>{try{const o=JSON.parse(e.data).msg;"mp3"===o.split(".").pop()?C.push(o):F.push(o),r++,r===a.length&&l(F,C)}catch(o){u("Error parsing JSON response:",o)}},fail:e=>{u("Upload failed for file",e)}})})(n)}))};function S(){e.index.chooseMedia({count:1,mediaType:["mix"],sourceType:["album","camera"],maxDuration:60,camera:"back",success(e){g.value.push(e.tempFiles[0].tempFilePath),"video"===e.tempFiles[0].fileType?_.value.push(e.tempFiles[0].thumbTempFilePath):_.value.push(e.tempFiles[0].tempFilePath)}})}function q(e){g.value.splice(e,1),_.value.splice(e,1)}const A=async()=>{try{j.value||await(async()=>{await e.index.authorize({scope:"scope.record",success:e=>{j.value=!0,console.log("trun")},fail:a=>{j.value=!1,console.error("用户拒绝了录音权限",a),e.index.showModal({title:"权限申请",content:"需要录音权限，请前往设置开启",showCancel:"取消",confirmText:"去设置",success:a=>{a.confirm&&e.index.openSetting()}})}})})(),j.value&&(w.value=!0,P.value=(new Date).getTime()/1e3,m.value.open(),y.start({format:"mp3"}))}catch(a){console.error(a)}},B=()=>{if(!w.value)return;const e=(new Date).getTime()/1e3;T.value=e-P.value,m.value.close(),y.stop()};y.onStop((e=>{if(T.value<1)return void W("录音时长过短");const{tempFilePath:a}=e;k.value.push(a);let l={url:a,progressWidth:Math.floor(T.value)};x.value.push(l),console.log("录音列表",x.value)}));const J=()=>{x.value.splice(b.value,1),f.value="删除成功",d.value.open(),v.value.close(),console.log("录音列表",x.value)};function O(){v.value.close()}const R=e=>{var a,l,o;n.value=e.detail.value,(null==(l=null==(a=i.value[n.value])?void 0:a.children[0])?void 0:l.sceneId)?D.sceneId=null==(o=i.value[n.value])?void 0:o.children[0].sceneId:D.sceneId=null},L=e=>{var a;t.value=e.detail.value,D.sceneId=null==(a=i.value[n.value])?void 0:a.children[t.value].sceneId},U=e=>{s.value=e.detail.value};function W(a){e.index.showToast({title:a,icon:"none",duration:2e3})}const z=()=>{e.index.navigateBack()};return(async()=>{let e=await l.apiGetSceneName({projectId:o.PROJECTID.globalProjectId});i.value=e.data.children})(),e.onUnmounted((()=>{I.destroy()})),(l,o)=>{var u,y,P,T,j;return e.e({a:a._imports_0$4,b:e.o(z),c:e.t(null==(u=i.value[n.value])?void 0:u.levelName),d:a._imports_1$2,e:e.o(R),f:n.value,g:i.value,h:(null==(y=i.value[n.value])?void 0:y.children.length)>0},(null==(P=i.value[n.value])?void 0:P.children.length)>0?{i:e.t(null==(T=i.value[n.value])?void 0:T.children[t.value].sceneName)}:{},{j:a._imports_1$2,k:e.o(L),l:t.value,m:null==(j=i.value[n.value])?void 0:j.children,n:e.t(r.value[s.value]),o:a._imports_1$2,p:e.o(U),q:s.value,r:r.value,s:e.f(g.value,((l,o,u)=>e.e({a:"mp4"===l.split(".").pop()},"mp4"===l.split(".").pop()?{b:_.value[o],c:a._imports_2$10,d:e.o((e=>{return a=l,c.value.open(),void(h.value=a);var a}),o),e:a._imports_3$5,f:e.o((e=>q(o)),o)}:{g:l,h:e.o((a=>{return o=l,void e.index.previewImage({current:"",urls:[o]});var o}),o),i:a._imports_3$5,j:e.o((e=>q(o)),o)},{k:o}))),t:a._imports_4$5,v:e.o(S),w:p.value,x:e.o((e=>p.value=e.detail.value)),y:e.o(A),z:e.o(B),A:e.o((()=>{})),B:a._imports_5$2,C:e.f(x.value,((l,o,u)=>e.e({a:$.value===o},$.value===o?{b:a._imports_1$9}:{c:a._imports_2$11},{d:e.t(l.progressWidth),e:20*l.progressWidth+"rpx",f:e.o((e=>(e=>{if(I.stop(),$.value===e)$.value="";else{$.value=e,I.src=x.value[e].url;let a=x.value[e];console.log("当前播放的是：",a),I.play(),I.onEnded((()=>{$.value=""}))}})(o)),o),g:e.o((e=>function(e){b.value=e,v.value.open()}(o)),o),h:o}))),D:a._imports_8$1,E:e.o(E),F:h.value,G:e.sr(c,"61476ae5-0",{k:"popup"}),H:e.p({type:"center"}),I:a._imports_9,J:e.sr(m,"61476ae5-1",{k:"recordingPopup"}),K:e.p({type:"center"}),L:e.p({type:"success",message:f.value,duration:1e3}),M:e.sr(d,"61476ae5-2",{k:"successPopup"}),N:e.p({type:"message"}),O:e.o(J),P:e.o(O),Q:e.sr(v,"61476ae5-4",{k:"deletePopup"}),R:e.p({type:"bottom","border-radius":"20rpx 20rpx 0 0","background-color":"#fff","safe-area":!0})})}}},r=e._export_sfc(u,[["__scopeId","data-v-61476ae5"]]);wx.createPage(r);
